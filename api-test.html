<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify API Test (Updated)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        #results {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .info-box {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 10px 15px;
            margin: 20px 0;
        }
        select {
            padding: 8px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>Shopify API Test (Updated)</h1>
    
    <div class="info-box">
        <h3>Troubleshooting the 401 Error</h3>
        <p>If you're seeing a 401 error, please make sure:</p>
        <ol>
            <li>You're using a <strong>Storefront API access token</strong> (not an Admin API token)</li>
            <li>The app has proper Storefront API scopes enabled</li>
            <li>Your shop domain is entered correctly</li>
        </ol>
    </div>
    
    <div>
        <div>
            <label for="shop-domain">Shop Domain:</label>
            <input type="text" id="shop-domain" value="sq8wck-y0.myshopify.com" style="width: 250px;">
        </div>
        <div style="margin-top: 10px;">
            <label for="api-version">API Version:</label>
            <select id="api-version">
                <option value="2024-04">2024-04 (Latest)</option>
                <option value="2024-01">2024-01</option>
                <option value="2023-10">2023-10</option>
                <option value="2023-07">2023-07</option>
                <option value="2023-04">2023-04</option>
            </select>
        </div>
        <div style="margin-top: 10px;">
            <label for="access-token">Storefront API Access Token:</label>
            <input type="text" id="access-token" placeholder="your Storefront API access token" style="width: 350px;">
        </div>
        <div style="margin-top: 20px;">
            <button id="test-button">Test API Connection</button>
        </div>
    </div>
    
    <h3>Connection Status:</h3>
    <div id="status"></div>
    
    <h3>API Response:</h3>
    <div id="results">Results will appear here...</div>

    <script>
        document.getElementById('test-button').addEventListener('click', function() {
            const shopDomain = document.getElementById('shop-domain').value.trim();
            const apiVersion = document.getElementById('api-version').value;
            const accessToken = document.getElementById('access-token').value.trim();
            
            if (!shopDomain || !accessToken) {
                alert('Please enter both shop domain and access token');
                return;
            }
            
            // Clear previous results
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            
            statusEl.innerHTML = '<p>Testing connection...</p>';
            resultsEl.textContent = 'Fetching data...';
            
            // Simple query to check if the API is working
            const query = `{
                shop {
                    name
                    primaryDomain {
                        url
                    }
                }
            }`;
            
            // Log the request details for debugging
            console.log(`Making request to: https://${shopDomain}/api/${apiVersion}/graphql.json`);
            console.log(`Using token: ${accessToken.substring(0, 5)}...${accessToken.substring(accessToken.length - 5)}`);
            
            // Make the API request
            fetch(`https://${shopDomain}/api/${apiVersion}/graphql.json`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Shopify-Storefront-Access-Token': accessToken
                },
                body: JSON.stringify({ query })
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    statusEl.innerHTML = `<p style="color: red">❌ Connection Failed: HTTP ${response.status} - ${response.statusText}</p>`;
                    
                    if (response.status === 401) {
                        statusEl.innerHTML += `
                            <p style="color: red">Authentication Error: Your access token appears to be invalid or has insufficient permissions.</p>
                            <p>Please check:</p>
                            <ul>
                                <li>You're using a <strong>Storefront API</strong> token (not an Admin API token)</li>
                                <li>The token has been copied correctly without extra spaces</li>
                                <li>The token hasn't expired or been revoked</li>
                            </ul>
                            <p>How to get a Storefront API token:</p>
                            <ol>
                                <li>Go to your Shopify admin</li>
                                <li>Click on "Apps" in the left sidebar</li>
                                <li>Click on "App and sales channel settings" at the bottom</li>
                                <li>Click "Develop apps" at the top right</li>
                                <li>Create a new app or select an existing one</li>
                                <li>Go to "API credentials"</li>
                                <li>Under "Storefront API", click "Install"</li>
                                <li>Select the required scopes (at minimum "unauthenticated_read_product_listings")</li>
                                <li>Copy the generated Storefront access token</li>
                            </ol>
                        `;
                    }
                }
                
                return response.json().catch(e => {
                    throw new Error(`Failed to parse JSON: ${e.message}`);
                });
            })
            .then(data => {
                // If we reach here, the connection was successful
                if (data.data && data.data.shop) {
                    statusEl.innerHTML = `<p style="color: green">✅ Connection Successful! Shop name: ${data.data.shop.name}</p>`;
                    
                    // Now try to fetch products
                    fetchProducts(shopDomain, apiVersion, accessToken);
                } else {
                    statusEl.innerHTML = `<p style="color: orange">⚠️ Partial Success: Connected but couldn't get shop data</p>`;
                    resultsEl.textContent = JSON.stringify(data, null, 2);
                }
            })
            .catch(error => {
                statusEl.innerHTML = `<p style="color: red">❌ Error: ${error.message}</p>`;
                console.error('API Error:', error);
            });
        });
        
        function fetchProducts(shopDomain, apiVersion, accessToken) {
            const resultsEl = document.getElementById('results');
            resultsEl.textContent = 'Fetching products...';
            
            // GraphQL query to get first 5 products
            const query = `{
                products(first: 5) {
                    edges {
                        node {
                            id
                            title
                            handle
                            description
                            variants(first: 3) {
                                edges {
                                    node {
                                        id
                                        title
                                        price {
                                            amount
                                            currencyCode
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }`;
            
            // Make the API request
            fetch(`https://${shopDomain}/api/${apiVersion}/graphql.json`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Shopify-Storefront-Access-Token': accessToken
                },
                body: JSON.stringify({ query })
            })
            .then(response => response.json())
            .then(data => {
                resultsEl.textContent = JSON.stringify(data, null, 2);
                
                // Check if products were successfully fetched
                if (data.data && data.data.products && data.data.products.edges.length > 0) {
                    document.getElementById('status').innerHTML += `
                        <p style="color: green">✅ Successfully fetched ${data.data.products.edges.length} products!</p>
                    `;
                } else {
                    document.getElementById('status').innerHTML += `
                        <p style="color: orange">⚠️ Connected to API but no products were found</p>
                    `;
                }
            })
            .catch(error => {
                resultsEl.textContent = `Error fetching products: ${error.message}`;
            });
        }
    </script>
</body>
</html>
